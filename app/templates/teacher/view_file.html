{% extends "base.html" %}

{% block title %}Smart Doc Insight - Dosya: {{ file_data.filename }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1>Dosya Analizi: {{ file_data.filename }}</h1>
        <p class="text-muted">Proje: <a href="{{ url_for('teacher.view_project', project_id=project._id) }}">{{ project.name }}</a></p>
    </div>
    <a href="{{ url_for('teacher.view_project', project_id=project._id) }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Projeye Dön
    </a>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Dosya Bilgileri</h5>
    </div>
    <div class="card-body">
        <p><strong>Dosya Adı:</strong> {{ file_data.filename }}</p>
        <p><strong>Yükleme Tarihi:</strong> {{ file_data.upload_date.strftime('%d.%m.%Y %H:%M') }}</p>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">LLM Analizi</h5>
        {% if analysis %}
        <div>
            <a href="{{ url_for('teacher.download_analysis', project_id=project._id, file_index=file_index) }}" class="btn btn-sm btn-secondary me-2">
                <i class="bi bi-download"></i> Raporu İndir
            </a>
            <form action="{{ url_for('teacher.analyze_file', project_id=project._id, file_index=file_index) }}" method="POST" class="d-inline">
                <button type="submit" class="btn btn-sm btn-primary analyze-button" 
                        onclick="return confirm('Dosyayı yeniden analiz etmek istediğinize emin misiniz? Bu işlem mevcut analizi silecektir.')">
                    <i class="bi bi-robot"></i> Tekrar Analiz Et
                </button>
            </form>
        </div>
        {% endif %}
    </div>
    <div class="card-body">
        {% set provider = g.active_llm_provider %}
        {% set provider_name = 'Ollama' if provider == 'ollama' else 'LM Studio' if provider == 'lmstudio' else 'OpenAI' if provider == 'openai' else 'Google Gemini' if provider == 'gemini' else 'Claude' if provider == 'claude' else 'Bilinmiyor' %}
        
        <div class="d-flex justify-content-end mb-3">
            <span class="badge {% if provider == 'ollama' %}bg-primary{% elif provider == 'lmstudio' %}bg-success{% elif provider == 'openai' %}bg-success-subtle text-dark{% elif provider == 'gemini' %}bg-info{% elif provider == 'claude' %}bg-warning{% else %}bg-secondary{% endif %}">
                <i class="bi 
                    {% if provider == 'ollama' %}bi-robot
                    {% elif provider == 'lmstudio' %}bi-cpu
                    {% elif provider == 'openai' %}bi-globe
                    {% elif provider == 'gemini' %}bi-google
                    {% elif provider == 'claude' %}bi-stars
                    {% else %}bi-question-circle
                    {% endif %}"></i>
                Aktif LLM Sağlayıcı: {{ provider_name }}
            </span>
        </div>
        
        {% if provider == 'ollama' and not g.ollama_available %}
            <div class="alert alert-warning mb-4" role="alert">
                <i class="bi bi-exclamation-triangle"></i> Ollama LLM servisi şu anda çalışmıyor. 
                Lütfen <a href="{{ url_for('main.system_status') }}" class="alert-link">sistem durumu</a> sayfasını kontrol edin
                veya <a href="{{ url_for('teacher.select_llm_provider') }}" class="alert-link">LLM Sağlayıcı Seçimi</a> sayfasından başka bir sağlayıcıya geçiş yapın.
            </div>
        {% elif provider == 'lmstudio' and not g.lmstudio_available %}
            <div class="alert alert-warning mb-4" role="alert">
                <i class="bi bi-exclamation-triangle"></i> LM Studio servisi şu anda çalışmıyor. 
                Lütfen <a href="{{ url_for('main.system_status') }}" class="alert-link">sistem durumu</a> sayfasını kontrol edin.
                LM Studio uygulamasının açık ve API'nin etkin olduğundan emin olun.
            </div>
        {% elif provider in ['openai', 'gemini', 'claude'] and not g.active_llm_available %}
            <div class="alert alert-warning mb-4" role="alert">
                <i class="bi bi-exclamation-triangle"></i> {{ provider_name }} API servisi şu anda kullanılamıyor. 
                <a href="{{ url_for('teacher.select_llm_provider') }}" class="alert-link">LLM Sağlayıcı Seçimi</a> sayfasından API anahtarınızı doğru girdiğinizden emin olun.
            </div>
        {% endif %}
        
        {% if analysis %}
            {% set llm_info = analysis.get('content', {}).get('llm_info', {}) %}
            {% set provider_name = llm_info.get('provider_name', 'Bilinmiyor') %}
            {% set model_name = llm_info.get('model', 'Bilinmiyor') %}
            {% set analysis_time = analysis.get('analyzed_at', '') %}
            
            <div class="mb-4">
                <div class="d-flex align-items-center">
                    <span class="badge bg-primary rounded-pill me-2">
                        <i class="bi bi-info-circle"></i> LLM Sağlayıcı: {{ provider_name }}
                    </span>
                    {% if model_name != 'Bilinmiyor' %}
                    <span class="badge bg-secondary rounded-pill me-2">
                        <i class="bi bi-cpu"></i> Model: {{ model_name }}
                    </span>
                    {% endif %}
                </div>
                <div class="mt-2 small text-muted">
                    <i class="bi bi-calendar3"></i> Analiz Tarihi: {{ analysis_time }}
                </div>
            </div>

            {# Grup Üyeleri #}
            {% if analysis.get('content', {}).get('grup_uyeleri') %}
            <div class="mb-4">
                <h5><i class="bi bi-people-fill"></i> Grup Üyeleri</h5>
                <ul class="list-group">
                    {% for uye in analysis.get('content', {}).get('grup_uyeleri', []) %}
                    <li class="list-group-item">{{ uye }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {# Sorumluluklar #}
            {% if analysis.get('content', {}).get('sorumluluklar') %}
            <div class="mb-4">
                <h5><i class="bi bi-check2-square"></i> Sorumluluklar</h5>
                <ul class="list-group">
                    {% for sorumluluk in analysis.get('content', {}).get('sorumluluklar', []) %}
                    <li class="list-group-item">{{ sorumluluk }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {# Diyagramlar #}
            {% if analysis.get('content', {}).get('diyagramlar') %}
            <div class="mb-4">
                <h5><i class="bi bi-bar-chart-line"></i> Diyagramlar</h5>
                <ul class="list-group">
                    {% for diyagram in analysis.get('content', {}).get('diyagramlar', []) %}
                    <li class="list-group-item">{{ diyagram }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {# Başlıklar #}
            {% if analysis.get('content', {}).get('basliklar') %}
            <div class="mb-4">
                <h5><i class="bi bi-bookmark-star"></i> Başlıklar</h5>
                <ul class="list-group">
                    {% for baslik in analysis.get('content', {}).get('basliklar', []) %}
                    <li class="list-group-item">{{ baslik }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {# Eksikler #}
            {% if analysis.get('content', {}).get('eksikler') %}
            <div class="mb-4">
                <h5><i class="bi bi-exclamation-triangle"></i> Eksikler</h5>
                <ul class="list-group">
                    {% for eksik in analysis.get('content', {}).get('eksikler', []) %}
                    <li class="list-group-item">{{ eksik }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {# Ham Sonuç #}
            {% if analysis.get('content', {}).get('ham_sonuc') %}
            <div class="mb-4">
                <a class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" href="#rawResult" role="button">
                    <i class="bi bi-code"></i> Ham LLM Çıktısı
                </a>
                <div class="collapse mt-2" id="rawResult">
                    <div class="card card-body">
                        <pre class="mb-0">{{ analysis.get('content', {}).get('ham_sonuc', '') }}</pre>
                    </div>
                </div>
            </div>
            {% endif %}
        {% else %}
            <div class="text-center py-5">
                <i class="bi bi-hourglass-split" style="font-size: 4rem; color: #ddd;"></i>
                <h4 class="mt-3">Henüz analiz yapılmadı</h4>
                <p class="text-muted">Bu PDF dosyasını LLM ile analiz etmek için "Analiz Et" butonuna tıklayın.</p>
                <form action="{{ url_for('teacher.analyze_file', project_id=project._id, file_index=file_index) }}" method="POST">
                    <button type="submit" class="btn btn-primary mt-2 analyze-button">
                        <i class="bi bi-robot"></i> Analiz Et
                    </button>
                </form>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Analiz butonuna tıklandığında yükleniyor göstergesi
document.addEventListener('DOMContentLoaded', function() {
    const analyzeButtons = document.querySelectorAll('.analyze-button');
    
    analyzeButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            // Eğer onay kutusu onaylandıysa
            if (!this.hasAttribute('onclick') || confirm('Dosyayı yeniden analiz etmek istediğinize emin misiniz? Bu işlem mevcut analizi silecektir.')) {
                // Buton metnini değiştir ve devre dışı bırak
                this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Analiz Ediliyor...';
                this.disabled = true;
                // Formu gönder
                this.closest('form').submit();
            }
        });
    });
});
</script>
{% endblock %} 